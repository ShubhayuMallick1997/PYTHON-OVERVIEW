# 14. **Working with Databases**

Working with databases is an essential part of any data-driven application. In Python, you can interact with databases using libraries such as `sqlite3` for SQLite databases or `SQLAlchemy` for more complex database management systems (DBMS) like PostgreSQL, MySQL, and SQLite.

## **1. SQLite in Python**

SQLite is a lightweight, disk-based database that doesn’t require a separate server process. It is ideal for applications that require simple, fast, and portable databases.

### **Connecting to an SQLite Database**

You can use the `sqlite3` module to interact with SQLite databases. Here’s how you can connect to an SQLite database:

```python
import sqlite3

# Connecting to a database (it will create the file if it doesn't exist)
conn = sqlite3.connect('example.db')

# Creating a cursor object to interact with the database
cursor = conn.cursor()
```

### **Creating a Table**

To create a table in the database, you can use the `CREATE TABLE` SQL command:

```python
cursor.execute('''
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY,
    name TEXT,
    age INTEGER
)
''')
conn.commit()
```

This command creates a table named `users` with columns for `id`, `name`, and `age`.

### **Inserting Data**

You can insert data into the table using the `INSERT INTO` SQL command:

```python
cursor.execute('''
INSERT INTO users (name, age)
VALUES (?, ?)
''', ('Alice', 30))

# Commit the changes
conn.commit()
```

The `?` placeholders are used to prevent SQL injection by safely inserting data.

### **Querying Data**

To query data from the table, you can use the `SELECT` statement:

```python
cursor.execute('SELECT * FROM users')
rows = cursor.fetchall()  # Fetch all rows from the result

for row in rows:
    print(row)
```

### **Updating Data**

To update data in the database, use the `UPDATE` statement:

```python
cursor.execute('''
UPDATE users
SET age = ?
WHERE name = ?
''', (31, 'Alice'))

conn.commit()
```

### **Deleting Data**

To delete data, use the `DELETE` statement:

```python
cursor.execute('''
DELETE FROM users
WHERE name = ?
''', ('Alice',))

conn.commit()
```

### **Closing the Connection**

Once you're done interacting with the database, it's important to close the connection:

```python
conn.close()
```

## **2. Using SQLAlchemy**

**SQLAlchemy** is a powerful Object-Relational Mapper (ORM) that allows you to work with databases using Python objects instead of writing raw SQL queries. It supports multiple databases, including SQLite, PostgreSQL, MySQL, and others.

### **Setting Up SQLAlchemy**

First, install SQLAlchemy:

```bash
pip install sqlalchemy
```

### **Defining a Database Model**

In SQLAlchemy, you define Python classes that correspond to database tables. Here’s an example of creating a database model:

```python
from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    name = Column(String)
    age = Column(Integer)

# Create a database engine
engine = create_engine('sqlite:///example.db')

# Create the table
Base.metadata.create_all(engine)
```

In this example, we define a `User` class, which represents the `users` table in the SQLite database.

### **Inserting Data Using SQLAlchemy**

To insert data, we use a **session** object:

```python
Session = sessionmaker(bind=engine)
session = Session()

# Create a new user
new_user = User(name="Alice", age=30)

# Add the new user to the session and commit the transaction
session.add(new_user)
session.commit()
```

### **Querying Data Using SQLAlchemy**

To retrieve data, we use the session object and query the database using the model class:

```python
user = session.query(User).filter_by(name="Alice").first()
print(user.name, user.age)  # Output: Alice 30
```

### **Updating Data Using SQLAlchemy**

To update data, simply modify the object and commit the changes:

```python
user.age = 31
session.commit()
```

### **Deleting Data Using SQLAlchemy**

To delete a record, first query the object and then delete it:

```python
user_to_delete = session.query(User).filter_by(name="Alice").first()
session.delete(user_to_delete)
session.commit()
```

### **Closing the Session**

Always close the session when you're done with the database:

```python
session.close()
```

## **3. Other Databases (PostgreSQL, MySQL, etc.)**

If you need to work with more advanced databases like **PostgreSQL** or **MySQL**, SQLAlchemy is an excellent choice, as it supports these systems out-of-the-box. You'll need to install the necessary database drivers (e.g., `psycopg2` for PostgreSQL or `mysql-connector-python` for MySQL) and configure the connection string appropriately.

Example (PostgreSQL):

```bash
pip install psycopg2
```

Example of creating a PostgreSQL connection with SQLAlchemy:

```python
from sqlalchemy import create_engine

engine = create_engine('postgresql://username:password@localhost/mydatabase')
```

## **4. Using Databases for Web Development**

When building web applications with frameworks like **Flask** or **Django**, SQLAlchemy is often used as the ORM to handle database interactions.

* **Flask**: SQLAlchemy integrates well with Flask for managing database connections and models.
* **Django**: Django has its own ORM, but you can use SQLAlchemy if you prefer more control over database operations.

## **5. Best Practices for Working with Databases**

* **Use ORM when possible**: Using an ORM like SQLAlchemy can simplify your database interactions and protect against SQL injection attacks.
* **Always close connections**: Be sure to close database connections and sessions when you are done to avoid resource leaks.
* **Write efficient queries**: When querying the database, try to minimize the amount of data you retrieve (e.g., avoid selecting unnecessary columns) and use indexes to speed up searches.
* **Handle exceptions**: Ensure that you handle exceptions like connection errors and query failures to maintain the stability of your application.

---

### **Why Work with Databases in Python?**

* **Persistence**: Databases allow you to persist data between program executions.
* **Scalability**: Relational databases like PostgreSQL and MySQL are designed to scale and handle large amounts of data efficiently.
* **Integration**: Databases are essential for building data-driven applications like web apps, CRMs, and enterprise systems.
* **Flexibility**: Whether you’re building a small project or a large-scale system, Python’s database tools (SQLite, SQLAlchemy) offer flexibility in choosing the best approach for your application’s needs.

By understanding and mastering database interaction in Python, you can build powerful, data-driven applications with efficiency and ease.
