# 28 . **Database Connectivity in Python**

Python provides several libraries to interact with databases, such as **SQLite**, **MySQL**, **PostgreSQL**, and **SQLAlchemy ORM**. Each of these libraries allows you to connect to a database, execute queries, and manipulate data in a structured way. Here's a breakdown of how to work with these databases using Python.

---

## **1. SQLite (using `sqlite3` module)**

**SQLite** is a lightweight, disk-based database that doesnâ€™t require a separate server process. It is included in Python's standard library, making it an easy option for small applications or when working with local databases.

### **Connecting to SQLite Database**

To connect to an SQLite database, you can use Python's built-in `sqlite3` module.

```python
import sqlite3

# Connect to SQLite database (creates a new database if it doesn't exist)
conn = sqlite3.connect('example.db')

# Create a cursor object to interact with the database
cursor = conn.cursor()

# Create a table
cursor.execute('''CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, name TEXT, age INTEGER)''')

# Insert data into the table
cursor.execute("INSERT INTO users (name, age) VALUES ('Alice', 30)")
cursor.execute("INSERT INTO users (name, age) VALUES ('Bob', 25)")

# Commit the changes
conn.commit()

# Query data from the table
cursor.execute("SELECT * FROM users")
rows = cursor.fetchall()
for row in rows:
    print(row)  # Output: (1, 'Alice', 30), (2, 'Bob', 25)

# Close the connection
conn.close()
```

### **Explanation:**

* **`sqlite3.connect()`**: Opens a connection to the database file. If the file doesn't exist, it creates a new one.
* **`cursor.execute()`**: Executes SQL queries (e.g., creating tables, inserting data).
* **`conn.commit()`**: Saves the changes to the database.
* **`cursor.fetchall()`**: Retrieves all rows from the query result.

### **Common SQLite Operations:**

* **Creating Tables**: Use `CREATE TABLE` to define the schema of your tables.
* **Inserting Data**: Use `INSERT INTO` to add new records.
* **Querying Data**: Use `SELECT` to retrieve data from tables.
* **Updating and Deleting Data**: Use `UPDATE` and `DELETE` for modifying or removing records.

---

## **2. Connecting to MySQL/PostgreSQL**

**MySQL** and **PostgreSQL** are more powerful, server-based relational databases that are often used in production systems. To connect to these databases, you can use external libraries such as **`mysql-connector-python`** for MySQL and **`psycopg2`** for PostgreSQL.

### **MySQL: Connecting Using `mysql-connector-python`**

1. **Install the MySQL connector:**

```bash
pip install mysql-connector-python
```

2. **Connecting to MySQL:**

```python
import mysql.connector

# Connect to MySQL database
conn = mysql.connector.connect(
    host="localhost",
    user="root",  # Your username
    password="password",  # Your password
    database="mydatabase"
)

cursor = conn.cursor()

# Create a table
cursor.execute("CREATE TABLE IF NOT EXISTS users (id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(255), age INT)")

# Insert data
cursor.execute("INSERT INTO users (name, age) VALUES (%s, %s)", ("Alice", 30))
cursor.execute("INSERT INTO users (name, age) VALUES (%s, %s)", ("Bob", 25))

# Commit changes
conn.commit()

# Query data
cursor.execute("SELECT * FROM users")
for row in cursor.fetchall():
    print(row)

# Close the connection
conn.close()
```

### **PostgreSQL: Connecting Using `psycopg2`**

1. **Install the PostgreSQL connector:**

```bash
pip install psycopg2
```

2. **Connecting to PostgreSQL:**

```python
import psycopg2

# Connect to PostgreSQL database
conn = psycopg2.connect(
    host="localhost",
    user="postgres",  # Your username
    password="password",  # Your password
    dbname="mydatabase"
)

cursor = conn.cursor()

# Create a table
cursor.execute("CREATE TABLE IF NOT EXISTS users (id SERIAL PRIMARY KEY, name VARCHAR(255), age INT)")

# Insert data
cursor.execute("INSERT INTO users (name, age) VALUES (%s, %s)", ("Alice", 30))
cursor.execute("INSERT INTO users (name, age) VALUES (%s, %s)", ("Bob", 25))

# Commit changes
conn.commit()

# Query data
cursor.execute("SELECT * FROM users")
for row in cursor.fetchall():
    print(row)

# Close the connection
conn.close()
```

### **Explanation:**

* **`mysql.connector.connect()`** (for MySQL) and **`psycopg2.connect()`** (for PostgreSQL) are used to establish a connection with the respective databases.
* **`cursor.execute()`**: Executes SQL queries.
* **`conn.commit()`**: Commits any changes (important for INSERT, UPDATE, DELETE operations).
* **`cursor.fetchall()`**: Fetches all the results of the query.

---

## **3. SQLAlchemy ORM (Object Relational Mapping)**

**SQLAlchemy** is a powerful SQL toolkit and Object Relational Mapper (ORM) for Python. It allows you to interact with relational databases in an object-oriented manner by mapping database tables to Python classes.

### **Why Use SQLAlchemy?**

* It provides an abstraction layer that makes database interactions easier and more Pythonic.
* It helps prevent SQL injection and makes code more maintainable.
* It supports multiple databases (MySQL, PostgreSQL, SQLite, etc.) with minimal changes to the code.

### **Basic Setup with SQLAlchemy**

1. **Install SQLAlchemy:**

```bash
pip install sqlalchemy
```

2. **Define a Database Model:**

```python
from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

# Define a base class for models
Base = declarative_base()

# Define a User class that represents a table
class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String)
    age = Column(Integer)

# Create an SQLite engine and create the tables
engine = create_engine('sqlite:///example.db', echo=True)
Base.metadata.create_all(engine)

# Create a session
Session = sessionmaker(bind=engine)
session = Session()

# Adding a new user
new_user = User(name='Alice', age=30)
session.add(new_user)
session.commit()

# Querying the database
users = session.query(User).all()
for user in users:
    print(user.id, user.name, user.age)

# Close the session
session.close()
```

### **Explanation:**

* **SQLAlchemy ORM**: It maps Python classes to database tables (like `User` class mapped to `users` table).
* **Session**: It allows interaction with the database (inserting, querying, updating, deleting data).
* **`create_engine()`**: Creates a connection to the database.
* **`session.add()`**: Adds an object to the session (to be committed to the database).
* **`session.commit()`**: Commits the transaction to the database.

### **SQLAlchemy Querying Example**

```python
# Query users with age greater than 25
older_users = session.query(User).filter(User.age > 25).all()
for user in older_users:
    print(user.name)
```

---

## **4. Best Practices for Database Connectivity**

* **Use SQLAlchemy ORM** for abstraction: It simplifies working with databases and is safer than raw SQL queries, especially when it comes to preventing SQL injection attacks.
* **Always close connections**: Use `session.close()` or `conn.close()` to ensure connections are properly closed after use.
* **Handle exceptions**: Wrap database operations in try-except blocks to manage connection errors and ensure proper error handling.
* **Use parameterized queries**: Always pass parameters safely using `cursor.execute()` or `session.query()` to prevent SQL injection.

---

## **Why Use SQLAlchemy, SQLite, MySQL, and PostgreSQL?**

* **SQLite**: Lightweight and simple to use, great for small applications or local data storage.
* **MySQL and PostgreSQL**: Robust and scalable databases suited for production environments. They support complex queries and are widely used in web applications.
* **SQLAlchemy ORM**: Provides an abstraction over raw SQL queries, simplifying database interactions and making your code more Pythonic and maintainable.

Mastering **SQLAlchemy ORM** and understanding how to interact with databases like **SQLite**, **MySQL**, and **PostgreSQL** will allow you to build powerful, data-driven applications in Python.
